name: LYX / CoatVision CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  backend:
    name: Backend (FastAPI / CoatVision Core)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest || echo "Ingen tester ennå – skipper feilblokker"

  admin_portal:
    name: Admin Portal (LYX-stil web)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: admin_portal
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Show repo layout
        run: |
          pwd
          ls -la
          echo "root package.json: $(test -f package.json && echo yes || echo no)"
          echo "root package-lock.json: $(test -f package-lock.json && echo yes || echo no)"
          echo "admin package.json: $(test -f package.json && echo yes || echo no)"
          echo "admin package-lock.json: $(test -f package-lock.json && echo yes || echo no)"
          echo "lyxvision_pro package-lock.json: $(test -f ../lyxvision_pro_app/package-lock.json && echo yes || echo no)"
          echo "lyxwash package-lock.json: $(test -f ../lyxwash_app/package-lock.json && echo yes || echo no)"
          echo "glasses_client package-lock.json: $(test -f ../glasses_client/package-lock.json && echo yes || echo no)"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json — running npm ci"
            npm ci
          else
            echo "No package-lock.json found — running npm install"
            npm install
          fi

      - name: Lint / build check
        run: |
          npm run lint || echo "Lint feilet – sjekk senere"
          npm run build || echo "Build feilet – sjekk senere"

  lyxvision_pro:
    name: LYXvision Pro App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: lyxvision_pro_app
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Show repo layout
        run: |
          pwd
          ls -la
          echo "package.json: $(test -f package.json && echo yes || echo no)"
          echo "package-lock.json: $(test -f package-lock.json && echo yes || echo no)"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json — running npm ci"
            npm ci
          else
            echo "No package-lock.json found — running npm install"
            npm install
          fi

      - name: Typecheck / lint
        run: |
          npm run lint || echo "Lint feilet – sjekk senere"
          npm run tsc --noEmit || echo "Typecheck feilet – sjekk senere"

  lyxwash:
    name: LYXwash App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: lyxwash_app
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Show repo layout
        run: |
          pwd
          ls -la
          echo "package.json: $(test -f package.json && echo yes || echo no)"
          echo "package-lock.json: $(test -f package-lock.json && echo yes || echo no)"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json — running npm ci"
            npm ci
          else
            echo "No package-lock.json found — running npm install"
            npm install
          fi

      - name: Typecheck / lint
        run: |
          npm run lint || echo "Lint feilet – sjekk senere"
          npm run tsc --noEmit || echo "Typecheck feilet – sjekk senere"

  glasses_client:
    name: Glasses Client (Web / AR overlay)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: glasses_client
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Show repo layout
        run: |
          pwd
          ls -la
          echo "package.json: $(test -f package.json && echo yes || echo no)"
          echo "package-lock.json: $(test -f package-lock.json && echo yes || echo no)"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json — running npm ci"
            npm ci
          else
            echo "No package-lock.json found — running npm install"
            npm install
          fi

      - name: Build
        run: |
          npm run build || echo "Build feilet – sjekk senere"
